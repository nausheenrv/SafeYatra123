<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safe Routing App</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }
        #map {
            height: 100%;
            width: 100%;
            pointer-events: auto; /* Ensure map interactions work */
        }
        .top-bar, .directions-form, .static-icons {
            position: absolute;
            z-index: 1000;
            pointer-events: auto; /* Allow interactions */
        }
        .top-bar {
            top: 0;
            width: 100%;
            padding: 10px;
            display: flex;
            align-items: center;
            background-color: #ffffff;
        }
        .directions-form {
            top: 60px;
            width: 100%;
            background-color: #ffffff;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: none; /* Initially hidden */
        }
        .static-icons {
            top: 70px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .icon {
            width: 50px;
            height: 50px;
            background-color: #ffffff;
            border-radius: 50%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .icon img {
            width: 60%;
            height: 60%;
        }
        .btn {
            background-color: #0c366d;
            border: #0c366d;
            color: #ffffff;
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AlzaSyDf34ue6DB4ukLmPqY09YJsZ4FXW_vs98Y&libraries=places"></script>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <img src="{{ url_for('static', filename='uploads/Logo.png') }}" alt="Safe Routing Logo" style="height: 40px;">
        <input type="text" id="searchBar" class="form-control mx-2" placeholder="Search for a location" style="flex: 1;">
        <button class="btn btn-primary" onclick="searchLocation()">Search</button>
    </div>

    <!-- Directions Form -->
    <div class="directions-form" id="directionsForm">
        <input type="text" id="startLocation" class="form-control mr-2" placeholder="Start Location" style="flex: 1;">
        <input type="text" id="endLocation" class="form-control mx-2" placeholder="Destination" style="flex: 1;">
        <button class="btn btn-primary" onclick="getDirections()">Get Directions</button>
    </div>

    <!-- Nearby Hospitals Button -->
    <div style="position: absolute; top: 60px; left: 20px; z-index: 1000;">
        <button class="btn btn-success" onclick="findNearbyHospitals()">Show Nearby Hospitals</button>
    </div>

    <!-- Static Icons -->
    <div class="static-icons">
        <div class="icon" onclick="window.location.href='{{ url_for('community') }}'">
            <img src="https://img.icons8.com/ios-filled/50/0c366d/bell.png" alt="Community">
        </div>
        <div class="icon" onclick="window.location.href='{{ url_for('submit_incident') }}'">
            <img src="https://img.icons8.com/ios-filled/50/0c366d/chat.png" alt="Submit Incident">
        </div>
        <div class="icon" onclick="window.location.href='{{ url_for('maps') }}'">
            <img src="https://img.icons8.com/ios-filled/50/0c366d/map.png" alt="Go to Maps Page">
        </div>
    </div>

    <!-- Fullscreen Map -->
    <div id="map"></div>

    <script>
        let map;

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 20.5937, lng: 78.9629 },
                zoom: 5,
                disableDefaultUI: true
            });
        }

        function searchLocation() {
            const location = document.getElementById('searchBar').value;
            const geocoder = new google.maps.Geocoder();

            geocoder.geocode({ address: location }, (results, status) => {
                if (status === 'OK') {
                    map.setCenter(results[0].geometry.location);
                    map.setZoom(14);
                    new google.maps.Marker({
                        map: map,
                        position: results[0].geometry.location
                    });
                } else {
                    alert('Geocode was not successful due to: ' + status);
                }
            });
        }

        function getDirections() {
            const startLocation = document.getElementById('startLocation').value;
            const endLocation = document.getElementById('endLocation').value;

            const directionsService = new google.maps.DirectionsService();
            const directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);

            const request = {
                origin: startLocation,
                destination: endLocation,
                travelMode: google.maps.TravelMode.DRIVING
            };

            directionsService.route(request, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                } else {
                    alert('Directions request failed due to: ' + status);
                }
            });
        }

        function findNearbyHospitals() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    const service = new google.maps.places.PlacesService(map);
                    service.nearbySearch({
                        location: userLocation,
                        radius: 5000,
                        type: ['hospital']
                    }, function(results, status) {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            results.forEach(createMarker);
                        } else {
                            alert('Nearby search failed due to: ' + status);
                        }
                    });

                    function createMarker(place) {
                        const marker = new google.maps.Marker({
                            map: map,
                            position: place.geometry.location
                        });

                        google.maps.event.addListener(marker, 'click', function() {
                            const infowindow = new google.maps.InfoWindow();
                            infowindow.setContent(place.name);
                            infowindow.open(map, this);
                        });
                    }
                }, function(error) {
                    alert('Error in getting location: ' + error.message);
                });
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        }

        window.onload = initMap;
    </script>
</body>
</html>